require('dotenv').config()
const { Telegraf, Markup, Scenes, session } = require('telegraf');
const { addCommentScene, searchNumberScene, writeDeveloperScene } = require('./scenes'); // Імпортуємо сцени

const { faker } = require('@faker-js/faker');

const { addUser, updateUser } = require('./controller/user.controller')
const pool = require('./db/db')
const bot = new Telegraf(process.env.BOT_TOKEN)
// Налаштовуємо Stage для сцен
const stage = new Scenes.Stage([addCommentScene, searchNumberScene,writeDeveloperScene]);
bot.use(session());
bot.use(stage.middleware()); // Додаємо сцену як middleware
bot.start(async (ctx) => {
    const { rows } = await pool.query(
        'SELECT * FROM bot_users WHERE tg_id = $1', 
        [ctx.message.from.id]  // Використовуємо параметр, щоб уникнути SQL-ін'єкцій
    );
    if (rows.length <= 0) {
        addUser(ctx.message.from.id,ctx.message.from.username)
    }else {
        updateUser(ctx.message.from.id,ctx.message.from.username)
    }
    const keyboard = [
        [
          { text: '✏️ Додати коментар' },  // Кнопка для додавання коментаря
          { text: '🔍 Пошук номеру' }   // Кнопка для пошуку номеру
        ],
        [
          { text: '💖 Підтримати проект' }  // Кнопка для підтримки проекту
        ],
        [
          { text: `Написати розробнику🧑‍💻` }  // Кнопка для підтримки проекту
        ]
      ];
    
      // Відправляємо повідомлення з клавіатурою, яка буде під полем вводу
      ctx.reply('Виберіть дію:', {
        reply_markup: {
          keyboard: keyboard,

          resize_keyboard: true     // Автоматично змінює розмір клавіатури під екран
        }
      });

});
// Обробники натискання кнопок
bot.hears('✏️ Додати коментар', (ctx) => {
    ctx.scene.enter('add_comment');  // Перехід до сцени для додавання коментаря
  });
  bot.hears('🔍 Пошук номеру', (ctx) => {
    ctx.scene.enter('search_number');  // Перехід до сцени для пошуку номеру
 
  });
  bot.hears('💖 Підтримати проект', async(ctx) => {
    const keyboard = [
      [
        { text: '✏️ Додати коментар' },  // Кнопка для додавання коментаря
        { text: '🔍 Пошук номеру' }   // Кнопка для пошуку номеру
      ],
      [
        { text: '💖 Підтримати проект' }  // Кнопка для підтримки проекту
      ],

    ];
    // Виводимо реквізити для підтримки проекту
   await ctx.reply('Дякуємо за вашу підтримку! Ось реквізити для донату:\n\n*Просто натисність на номер карти і він автоматично скопіюється*',{
    parse_mode: 'Markdown'
   });
  


   await ctx.reply("MONO `4441111059239701` \n\nPrivat `5363542108614588`", {
    parse_mode: 'Markdown',    reply_markup: {
      keyboard: keyboard,
      one_time_keyboard: true,  // Клавіатура зникне після вибору
      resize_keyboard: true     // Автоматично змінює розмір клавіатури під екран
    }
  });

  });
  bot.hears('Написати розробнику🧑‍💻', async(ctx) => {
    ctx.scene.enter('write_owner');  // Перехід до сцени для пошуку номеру


  });



  bot.command('help',async (ctx) =>{
    await ctx.reply
  })








// Массив українських префіксів номерів телефонів
const prefixes = ['098', '097', '099', '093', '073', '067'];

// Функція для генерації випадкових телефонних номерів
function generatePhoneNumber() {
  const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
  const number = Math.floor(Math.random() * 1000000).toString().padStart(7, '0');
  return prefix + number;
}

// Функція для генерації випадкових коментарів
function generateComment() {
  const positiveComments = [
    'пупс, ти просто кайф 😎',
    'хах, твій номер крутий, тільки ти інколи тупиш 🤣',
    'ти такий милий, мій коханий 😍',
    'топчик, з тобою завжди весело 😆',
    'милашка, ти такий класний 😘',
    'норм, чувачок, але інколи на нервах 😂',
    'все ок, але не завжди розумієш 😂',
    'ти насправді класний, але трохи бідло 😅',
    'швидко відповідаєш, молодець 😏',
    'ти реально мілашка, не знімай вже 😂',
    'ти шалено крутий, але інколи дратуєш 😅',
    'ну ти і смішний, без тебе скучно 💀',
    'покажи ще, як ти смішно реагуєш 😂',
    'мій пупсик, коли зустрічаємось? 😜',
    'ну ти реально прикольний, але інколи тормозиш 🐢',
    'підходиш, але інколи здається, що не норм 🙄',
    'норм, але трохи зашквар 😏',
    'ти так класно спілкуєшся, але інколи скидаєш 🤦‍♂️',
    'ты похож на те, что даешь, да, но иногда не по теме 😅',
    'це моє, просто коли ти не тупиш, супер 😂',
    'ти реально зашквар, але інколи супер 💀',
    'ммм, норм пацан, але інколи заскучав 🤨',
    'хочеш вийти на зв’язок? 😂',
    'тебе не можна оставляти на один, бо ти мрійник 😜',
    'ти реально сумний, але як кумедно 😉',
    'хоч і не ідеальний, але дуже прикольний 🤪',
    'сильно не тисни, бо ще щось лопне 😂',
    'ти цікава особистість, але інколи гірше ☠️',
    'як би ти не виглядав, твоя поведінка типова 😆',
    'відповідаєш швидко, але деякі речі не зовсім точні 🤣',
    'все б нічого, але все одно не вистачає креативу 😛',
    'стільки разів насмішив, але не стільки виглядаєш 🤣',
    'ну ти в мене ненормальний 😜',
    'все ж в тебе класно, але інколи без розуму 😅',
    'спокійно, пупсик, я в тебе вірю 🤗',
    'ну да, по-любому норм, але чому не розумієш 🙄',
    'ну норм, але тільки раз в тиждень 😎',
    'ти реально треш, але ми по твоєму 😂',
    'дуже класний, тільки розслабся на пару годин 😉',
    'чувачок, знову тупиш, а я думав ти розумний 😅',
    'не дивись на мене, я ображаюсь 😜',
    'тіпа я тебе бачу норм, але ти інколи піпець 🤣',
    'твоя логіка: завжди трохи тупо, але смішно 😜',
    'ти супер, коли не тролиш 😂',
    'інколи дивлюсь на тебе і не можу зрозуміти, що ти хочеш 😆',
    'ти зашквар, але через пару хвилин все відновлюється 😅',
    'ти такий, шо прям вау 😍',
    'ти реально крутий, але інколи все змінюється 😜',
    'думаю, що знову помиляюсь, але ти прикольний 👀',
    'ну ти типу класний, але я не дуже сприймаю 😅',
    'ти завжди знайдеш, чим здивувати 😏',
    'що ти там собі думаєш, ну типу добре 😂',
    'я тебе просто обожнюю, але насправді ти фейк 😜',
    'ти супер, але багато жартуєш 😂',
    'навіть коли ти не робиш нічого, виглядаєш кумедно 😆',
    'ну ти, типу, пупсик, але трохи грубий інколи 😅',
    'він класний, але інколи сліпий на очі 😏',
    'я не знаю як ти це робиш, але це смішно 💀'
  ];
  

  const negativeComments = [
    'Цей пупс не бере трубку, відстань ***',
    'Від цього типу ніякої толку, не відповідає ***',
    'Цей чувак тупо не може нормально поспілкуватись 🤦‍♂️',
    'Ти що взагалі, якесь *** не можеш взяти трубку? 🧐',
    'Ти реально *** або що? Дзвоню, а ти не відповідаєш!',
    'Якщо цей *** знову не відповість, я просто зламаю телефон 📱',
    'Знову не відповів? Ігнорує як останнє ***',
    'Цей "мілашка" навіть трубку не бере 🤬',
    'Ну ти і ***! Постійно ігноруєш дзвінки',
    'Цей хлопець за*бав, дзвоню йому, а він все ігнорує 😡',
    'Знову цей *** не відповідає на дзвінки! Я вже задовбався 🚫',
    'Ти реально такий *** або просто не відповідаєш на дзвінки? 🥴',
    'Цей чувак просто *** навіть не бере трубку! 🔕',
    'Ти що, *** не вмієш нормально відповісти на дзвінок? 🤦‍♀️',
    'Цей тип реально ігнорує всі дзвінки, як можна так? ***',
    'Ну ти і ***! Навіщо взагалі телефон, якщо не відповідаєш? 😤',
    'Цей хлопець просто не розуміє, що дзвінки потрібно брати ***',
    'Цей "милашка" навіть на повідомлення не відповідає, ***',
    'Чувак, ти якесь *** не можеш нормально поговорити 📞',
    'Цей пупс реально не відповідає на дзвінки, що за відношення? ***',
    'Невже так важко відповісти на дзвінок, ***?',
    'Ти що, зовсім ***? Ігноруєш усіх на світі 😡',
    'Цей тип реально ігнорує дзвінки, скільки можна? ***',
    'Не можу зрозуміти, чому цей *** не бере трубку, абсолютно не поважає людей 🤬',
    'Ти взагалі *** або просто лінуєшся нормально відповісти? 🤔',
    'Ти не вважаєш за потрібне брати трубку? Потрібно поважати хоча б трохи людей, ***',
    'Цей *** навіть на короткі дзвінки не відповідає, нудно з тобою 😑',
    'Ти що, ***? Дзвониш і він не бере трубку, ігнорує все 🛑',
    'Цей тип просто не знає, як відповідати на дзвінки, якийсь ***',
    'Не можу зрозуміти, що з ним не так, або в нього ніколи немає часу? ***',
    'Цей чувак реально не бере трубку, яке відношення? ***'
  ]  
  // Випадково вибираємо коментар
  const isPositive = Math.random() > 0.5; // 50% шанс на позитивний або негативний коментар
  const comment = isPositive
    ? positiveComments[Math.floor(Math.random() * positiveComments.length)]
    : negativeComments[Math.floor(Math.random() * negativeComments.length)];

  // Додаємо випадкові помилки в текст коментаря (наприклад, заміна літер)
  const errors = Math.random() > 0.7; // 30% шанс на помилку
  // if (errors) {
  //   return comment.split('').map(char => (Math.random() > 0.9 ? faker.random.alphaNumeric(1) : char)).join('');
  // }

  return comment;
}

// Функція для запису коментарів в базу даних
async function saveCommentToDB(phoneNumber, comment) {
  try {
    const query = 'INSERT INTO phone_comments (phone, comment) VALUES ($1, $2)';
    await pool.query(query, [phoneNumber, comment]);
    console.log(`Коментар для номера ${phoneNumber} успішно записаний.`);
  } catch (err) {
    console.error('Помилка при записі коментаря в базу даних:', err);
  }
}

// Головна функція для циклічного запису коментарів
async function generateAndSaveComments() {
  let count = 0;

  for (let i = 0; i <= 999999; i++) {
    const phoneNumber = generatePhoneNumber();
    const comment = generateComment();

    await saveCommentToDB(phoneNumber, comment);

    // Виводимо прогрес кожні 1000 записів
    count++;
    if (count % 1000 === 0) {
      console.log(`Записано ${count} коментарів...`);
    }
  }

  console.log('Всі коментарі успішно записані.');
}

// Запускаємо процес генерації та запису
// generateAndSaveComments().catch(err => console.error('Помилка:', err));




bot.launch()
// Обробка помилок
bot.catch((err) => {
    console.error('Error occurred', err);
  });
// Enable graceful stop
process.once('SIGINT', () => bot.stop('SIGINT'))
process.once('SIGTERM', () => bot.stop('SIGTERM'))