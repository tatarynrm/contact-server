const { Scenes, Markup } = require('telegraf');
const pool = require('../db/db');

// –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å—Ü–µ–Ω–∏
const addCommentScene = new Scenes.WizardScene(
  'add_comment',

  // –ö—Ä–æ–∫ 1: –í–≤–µ–¥–µ–Ω–Ω—è –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω—É
  async (ctx) => {
    const keyboard = [
      [
        { text: '–í–∏–π—Ç–∏ –≤ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é' },  // –ö–Ω–æ–ø–∫–∞ –¥–ª—è –≤–∏—Ö–æ–¥—É
      ]
    ];
    // –í–∏–≤–µ–¥–µ–Ω–Ω—è –∑–∞–ø–∏—Ç—É –¥–ª—è –≤–≤–µ–¥–µ–Ω–Ω—è –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω—É
    ctx.reply('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É —É —Ñ–æ—Ä–º–∞—Ç—ñ 0989578520:', {
      reply_markup: {
        keyboard: keyboard,
        one_time_keyboard: true,  // –ö–ª–∞–≤—ñ–∞—Ç—É—Ä–∞ –∑–Ω–∏–∫–Ω–µ –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É
        resize_keyboard: true     // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–º—ñ–Ω—é—î —Ä–æ–∑–º—ñ—Ä –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏ –ø—ñ–¥ –µ–∫—Ä–∞–Ω
      }
    });




    // –ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –∫—Ä–æ–∫—É
    ctx.wizard.next();
  },

  // –ö—Ä–æ–∫ 2: –û–±—Ä–æ–±–∫–∞ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω—É
  async (ctx) => {
    const phone = ctx.message.text.trim();
    console.log('–í–≤–µ–¥–µ–Ω–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É:', phone);

    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω—É
    const phoneRegex = /^0\d{9}$/;
    if (!phoneRegex.test(phone)) {
      ctx.reply('–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω—É. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
      return;
    }

    // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω—É –≤ —Å–µ—Å—ñ—ó
    ctx.session.userData = { phone };

    // –ó–∞–ø–∏—Ç –Ω–∞ –≤–≤–µ–¥–µ–Ω–Ω—è –∫–æ–º–µ–Ω—Ç–∞—Ä—è
    ctx.reply('–¢–µ–ø–µ—Ä –≤–≤–µ–¥—ñ—Ç—å –≤–∞—à –∫–æ–º–µ–Ω—Ç–∞—Ä:', {
      reply_markup: {
        remove_keyboard: true, // –í—ñ–¥–∫–ª—é—á–∏—Ç–∏ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—É –ø—ñ—Å–ª—è –≤–≤–µ–¥–µ–Ω–Ω—è –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω—É
      }
    });


    // –ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –∫—Ä–æ–∫—É
    ctx.wizard.next();
  },

  // –ö—Ä–æ–∫ 3: –û–±—Ä–æ–±–∫–∞ –∫–æ–º–µ–Ω—Ç–∞—Ä—è
  async (ctx) => {
    const comment = ctx.message.text.trim();

    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –∫–æ–º–µ–Ω—Ç–∞—Ä –≤ —Å–µ—Å—ñ—ó
    ctx.session.userData.comment = comment;

    // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —ñ–Ω–ª–∞–π–Ω –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏ –∑ —Ç—Ä—å–æ–º–∞ –∫–Ω–æ–ø–∫–∞–º–∏
// –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —ñ–Ω–ª–∞–π–Ω –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏ –∑ —Ç—Ä—å–æ–º–∞ –∫–Ω–æ–ø–∫–∞–º–∏ –≤ –æ–¥–Ω–æ–º—É —Ä—è–¥–∫—É
await ctx.reply(`–†–µ–∑—É–ª—å—Ç–∞—Ç: \n\n –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É: ${ctx.session.userData.phone} \n\n–ö–æ–º–µ–Ω—Ç–∞—Ä: ${ctx.session.userData.comment} `, Markup.inlineKeyboard([
  [
    Markup.button.callback('–ó–±–µ—Ä–µ–≥—Ç–∏', 'save'),
    Markup.button.callback('–ü–æ—á–∞—Ç–∏ –∑–Ω–æ–≤—É', 'restart'),

  ]
  
]));

const keyboard = [
  [
    { text: '–í–∏–π—Ç–∏ –≤ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é' },  // –ö–Ω–æ–ø–∫–∞ –¥–ª—è –≤–∏—Ö–æ–¥—É
  ]
];
// –í–∏–≤–µ–¥–µ–Ω–Ω—è –∑–∞–ø–∏—Ç—É –¥–ª—è –≤–≤–µ–¥–µ–Ω–Ω—è –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω—É
ctx.reply('–û–±–µ—Ä—ñ—Ç—å –¥—ñ—é', {
  reply_markup: {
    keyboard: keyboard,
    one_time_keyboard: true,  // –ö–ª–∞–≤—ñ–∞—Ç—É—Ä–∞ –∑–Ω–∏–∫–Ω–µ –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É
    resize_keyboard: true     // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–º—ñ–Ω—é—î —Ä–æ–∑–º—ñ—Ä –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏ –ø—ñ–¥ –µ–∫—Ä–∞–Ω
  }
});
  }
);



// –û–±—Ä–æ–±–Ω–∏–∫ callback –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ó–±–µ—Ä–µ–≥—Ç–∏"
addCommentScene.action('save', async (ctx) => {
  const { phone, comment } = ctx.session.userData;
  const tg_id = ctx.from.id
  ctx.answerCbQuery();

  if (phone && comment) {
    try {
      // –í–∞—à –∫–æ–¥ –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö
      const result = await pool.query(
        'INSERT INTO phone_comments (phone, comment,comment_owner) VALUES ($1, $2,$3) RETURNING *',
        [phone, comment,tg_id]
      );

      // –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ø—Ä–æ —É—Å–ø—ñ—à–Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
      ctx.reply(`–í–∞—à –∫–æ–º–µ–Ω—Ç–∞—Ä: "${comment}" –∑ –Ω–æ–º–µ—Ä–æ–º: ${phone} –∑–±–µ—Ä–µ–∂–µ–Ω–æ –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö.`);

    } catch (err) {
      console.error('Error saving to PostgreSQL', err.stack);
      ctx.reply('–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
    }
  } else {
    ctx.reply('–ü–æ–º–∏–ª–∫–∞: –≤—ñ–¥—Å—É—Ç–Ω—ñ –¥–∞–Ω—ñ –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è.');
  }

  // –ü–æ–∫–∏–¥–∞—î–º–æ —Å—Ü–µ–Ω—É
  const keyboard = [
    [
      { text: '‚úèÔ∏è –î–æ–¥–∞—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä' },  // –ö–Ω–æ–ø–∫–∞ –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∫–æ–º–µ–Ω—Ç–∞—Ä—è
      { text: 'üîç –ü–æ—à—É–∫ –Ω–æ–º–µ—Ä—É' }   // –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ—à—É–∫—É –Ω–æ–º–µ—Ä—É
    ],
    [
      { text: 'üíñ –ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–æ–µ–∫—Ç' }  // –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –ø—Ä–æ–µ–∫—Ç—É
    ]
  ];

  // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–æ—é, —è–∫–∞ –±—É–¥–µ –ø—ñ–¥ –ø–æ–ª–µ–º –≤–≤–æ–¥—É
  ctx.reply('–í–∏–±–µ—Ä—ñ—Ç—å –¥—ñ—é:', {
    reply_markup: {
      keyboard: keyboard,
      one_time_keyboard: true,  // –ö–ª–∞–≤—ñ–∞—Ç—É—Ä–∞ –∑–Ω–∏–∫–Ω–µ –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É
      resize_keyboard: true     // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–º—ñ–Ω—é—î —Ä–æ–∑–º—ñ—Ä –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏ –ø—ñ–¥ –µ–∫—Ä–∞–Ω
    }
  });
  ctx.scene.leave();
});

// –û–±—Ä–æ–±–Ω–∏–∫ callback –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü–æ—á–∞—Ç–∏ –∑–Ω–æ–≤—É"
addCommentScene.action('restart', (ctx) => {
  ctx.answerCbQuery();

  // –û—á–∏—Å—Ç–∏–º–æ –¥–∞–Ω—ñ —Å–µ—Å—ñ—ó –ø–µ—Ä–µ–¥ –ø–æ—á–∞—Ç–∫–æ–º –∑–∞–Ω–æ–≤–æ
  ctx.session.userData = {};  // –û—á–∏—Å—Ç–∫–∞ —Å–µ—Å—ñ—ó

  // –ó–∞–ø–∏—Ç—É—î–º–æ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É –∑–Ω–æ–≤—É
  ctx.reply('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É —â–µ —Ä–∞–∑:');
  
  // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—è –¥–æ –ø–µ—Ä—à–æ–≥–æ –∫—Ä–æ–∫—É —Å—Ü–µ–Ω–∏
  ctx.wizard.selectStep(1)
});

addCommentScene.command('start',(ctx) =>{
  ctx.scene.leave()
  const keyboard = [
    [
      { text: '‚úèÔ∏è –î–æ–¥–∞—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä' },  // –ö–Ω–æ–ø–∫–∞ –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∫–æ–º–µ–Ω—Ç–∞—Ä—è
      { text: 'üîç –ü–æ—à—É–∫ –Ω–æ–º–µ—Ä—É' }   // –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ—à—É–∫—É –Ω–æ–º–µ—Ä—É
    ],
    [
      { text: 'üíñ –ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–æ–µ–∫—Ç' }  // –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –ø—Ä–æ–µ–∫—Ç—É
    ]
  ];

  // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–æ—é, —è–∫–∞ –±—É–¥–µ –ø—ñ–¥ –ø–æ–ª–µ–º –≤–≤–æ–¥—É
  ctx.reply('–í–∏–±–µ—Ä—ñ—Ç—å –¥—ñ—é:', {
    reply_markup: {
      keyboard: keyboard,

      resize_keyboard: true     // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–º—ñ–Ω—é—î —Ä–æ–∑–º—ñ—Ä –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏ –ø—ñ–¥ –µ–∫—Ä–∞–Ω
    }
  });
})
addCommentScene.hears('–í–∏–π—Ç–∏ –≤ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é',(ctx) =>{
  ctx.scene.leave()
  const keyboard = [
    [
      { text: '‚úèÔ∏è –î–æ–¥–∞—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä' },  // –ö–Ω–æ–ø–∫–∞ –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∫–æ–º–µ–Ω—Ç–∞—Ä—è
      { text: 'üîç –ü–æ—à—É–∫ –Ω–æ–º–µ—Ä—É' }   // –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ—à—É–∫—É –Ω–æ–º–µ—Ä—É
    ],
    [
      { text: 'üíñ –ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–æ–µ–∫—Ç' }  // –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –ø—Ä–æ–µ–∫—Ç—É
    ]
  ];

  // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–æ—é, —è–∫–∞ –±—É–¥–µ –ø—ñ–¥ –ø–æ–ª–µ–º –≤–≤–æ–¥—É
  ctx.reply('–í–∏–±–µ—Ä—ñ—Ç—å –¥—ñ—é:', {
    reply_markup: {
      keyboard: keyboard,

      resize_keyboard: true     // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–º—ñ–Ω—é—î —Ä–æ–∑–º—ñ—Ä –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏ –ø—ñ–¥ –µ–∫—Ä–∞–Ω
    }
  });
})
module.exports = addCommentScene;
